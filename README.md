# Hand card

## 1. Цель проекта
Цель проекта - разработаь приложение для ранжирования скидочных кард клиента по геолокации

## 2. Описание системы

### 2.1 Функционал пользователя

#### 2.1.1 Авторизация

- Регистрация

- Вход

#### 2.1.2 Просмотр скидочных карт

Список с обложкой скидочных карт (Пример: Чашка кофе)

#### 2.1.3 Pop up

Пользователь нажимает на карточку, которая маштабируется на весь экран:

- Название (Пример: Чашка кофе)

- Номер (Пример: 12345de545421)

- Категория (Пример: Кафе)

#### 2.1.4 Добавление карты

- Название (Пример: Чашка кофе)

- Номер (Пример: 12345de545421)

- Категория (Пример: Кафе)

#### 2.1.5 Удаление карты

#### 2.1.6 Ранжирование карт по геолокации

## 3. Стек технологий

### Бекенд

- Язык - `Go`

- БД - `Postgres`

- Фреймворк [Gin](https://github.com/gin-gonic/gin)

- Конфигурация приложения - [cleanenv](https://github.com/ilyakaznacheev/cleanenv)

- Работа с БД - [sqlx](https://github.com/jmoiron/sqlx)

- Логер - [logrus](https://github.com/sirupsen/logrus)

- Работа с токеном - [JWT](https://github.com/golang-jwt/jwt)

- Env конфигуратор

### Фронтенд

- Язык - [Flutter/Dart](https://flutter.dev)

### DevOps
- Сборка - `Docker`

- `CI/CD`

## 4. Архитектура

### Бекенд `/backend`

За основу взята чистая архитектура [clean architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

#### Директории:
- `/cmd` - запуск приложения

- `/config` - работа с конфигом

- `/db` - миграции

- `/internal` - архитектура проекта

- `/cmd` - подключение дополнительных пакетов и работа с внешними api

#### Пакеты:

`/pkg`:

- `/server` - настройка сервиса

- `/map_api` - интерфейс работы с внешним api

- `/map_api/gis_api` -  реализация интерфейса работы с внешним api (2Гис api)

- `/postgres` - настройка postgres

`internal`:

- `/app` - сборка всех пакетов для работы сервиса

- `/controller/http/v1` - работа с роутерами и фреймворком Gin и middleware аутентификации

- `/controller/http/dto` - сущности, которые передааются и принимаются от клиента

- `/domain` - интерфейс бизнесс логики

- `/domain/use_case` - реализация интерфейсов бизнесс логики

- `/entities` - сущности, которые передаются в бизнесс логике

- `/adapter/db` - интерфейс работы с бд

- `/adapter/db/postgres_db` - реализация интерфейса работы с бд (Postgres SQL)

### Фронтенд `/mobile`

Архитектрура  MVC

#### `/lib`:

- `/main.dart` - запуск приложения

- `/pages` - верстка экранов (View)

- `/controller` - запросы к бекенду (Controller)

- `/model` - сущности приложения

- `/service` - реализация дополнительных пакетов для работы

Экраны:

#### `/pages`:

- `/sign-in_page.dart` - страница с входом

- `/sign-up_page.dart` - страница с регистрацией

- `/home_page.dart` - главная страница

![sign](resource/sign-in.png)

## 5. Диаграмма БД

![diagram_bd](resource/diagram_bd.png)

### Сущности:
 
`users` - данные пользователя

`сards` - данные карты

`categories` - информация о категории карты

`user_cards` - пользователи и карты

## 6. Rest api

### POST

- `/auth/sign-up` Метод регистрации пользователя

Curl:
```
curl --location --request POST 'http://localhost:8080/auth/sign-up' \
--header 'Content-Type: text/plain' \
--data-raw '{
    "email": "vladik32g@mail.ru",
    "password": "qwerty",
    "login": "vladjong"
}'
```

- `/auth/sign-up` Метод входа в систему

Curl:
```
curl --location --request POST 'http://localhost:8080/auth/sign-in' \
--header 'Content-Type: text/plain' \
--data-raw '{
    "password": "qwerty",
    "login": "vladjong"
}'
```

- `/api/cards` Метод добавления карты

Curl:
```
curl --location --request POST 'http://localhost:8080/api/cards' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NzAyOTE3MTMsImlhdCI6MTY3MDI0ODUxMywidXNlcl9pZCI6MX0.zgYDTxuDDDNroIeKIev7XbLnzL64k3OupIWP9elt0_4' \
--header 'Content-Type: text/plain' \
--data-raw '{
    "organization": "Чашка кофе",
    "number": "A123FE32",
    "category_name": "Кафе"
}'
```

### GET

- `/api/cards` Метод просмотра карт пользователя

Curl:
```
curl --location --request GET 'http://localhost:8080/api/cards/?lat=82.897918&lon=54.980332' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NzAyOTE4ODcsImlhdCI6MTY3MDI0ODY4NywidXNlcl9pZCI6MX0.wlslwHLuNR37ly73epnTClfVQw-nmVEpQeUgJOpglyU'
```

### DELETE

- `/api/cards/:id` Метод удаления карты пользователя

Curl:
```
curl --location --request DELETE 'http://localhost:8080/api/cards/1' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NzAyOTE4ODcsImlhdCI6MTY3MDI0ODY4NywidXNlcl9pZCI6MX0.wlslwHLuNR37ly73epnTClfVQw-nmVEpQeUgJOpglyU'
```

## 7. Use case диаграмма

![use_case_diagram](resource/use_case_diagram.png)

## 8. Use case

### Вход в систему

| Наименование Use case | Вход в систему                                                  |
|-----------------------|-----------------------------------------------------------------|
| Описание              | Вход пользователя в систему для получения доступа к функционалу |
| Акторы                | Пользователь |
| Предусловия           | Подключение системы к сети |


| Основноые сценарии | Номер |        Шаги                                             |
|--------------------|-------|---------------------------------------------------------|
|    Пользователь    |   1   | Ввод логина и пароля                                    |
|                    |   2   | Проверка системой имени пользователя и пароля           |
|                    |   3   | Система назначает JWT токен пользователю на 12 часов    |
|   Результат        |   4   | Пользователь входит в основное меню                     |
|   Расширения       |   1а  | Ошибка ввода данных пользователя. Система выдает ошибку. Переход на 1 шаг |

### Добавление карты

| Наименование Use case | Добавление карты                                                  |
|-----------------------|-------------------------------------------------------------------|
| Описание              | Добавление скидочной карты в приложение                           |
| Акторы                | Пользователь                                                      |
| Предусловия           | Вход в систему                                                    |


| Основноые сценарии | Номер |        Шаги                                             |
|--------------------|-------|---------------------------------------------------------|
|    Пользователь    |   1   | Ввод название, номер, категория карты                   |
|                    |   2   | Проверка системой названия, номера, категории           |
|                    |   3   | Система проверяет JWT токен пользователя                |
|                    |   4   | Система создает новую запись в БД                       |
|                    |   5   | Система выдает сообщение об успешном добавление карты   |
|   Результат        |   -   | Карта появляется в списке карт пользователя             |
|   Расширения       |   1а  | Карта с данным номером уже существует. Система показывает сообщение об ошибке. Переход на 1 шаг |

### Показ карт

| Наименование Use case | Показ карт                                                 |
|-----------------------|-------------------------------------------------------------------|
| Описание              | Пользователь входит в главное меню                           |
| Акторы                | Пользователь                                                      |
| Предусловия           | Вход в систему                                                    |


| Основноые сценарии | Номер |        Шаги                                             |
|--------------------|-------|---------------------------------------------------------|
|    Пользователь    |   1   | Система оопределяет координаты пользователя             |
|                    |   2   | Система отправляет координаты пользователя API          |
|                    |   3   | Система проверяет наличие координат                     |
|                    |   4   | Система делает запрос к бд, для выбора карт пользователя|
|                    |   5   | Система делает запрос к внешнему API для определения списка организаций по близости с пользователем |
|                    |   6   | Система сравнивает карты пользователя с организациями   |
|                    |   7   | Система отправляет на устройство пользователя список ранжируемых карт |
|  Результат         |   -   | Пользователь ввидит на экране свои скидочные карты |
|  Расширения        |   3а  | Координаты пользователя отсутствуют. Система выводит не ранжированный список карт пользователя |
|  Расширения        |   4а  | Сбой работы с внешним api. Система выводит не ранжированный список карт пользователяg |

## Тесты

### Виды тестов:

- Map_api (Api 2Гис)

- Api (Backend приложения)

Метрики:

- Количество пройденных тестов: 10

- Количество проваленных тестов: 4

- Отношение выполненных кейсов к общему числу кейсов: 0.71

- Отношение проваленных кейсов к общему числу кейсов: 0.29

- Среднее время прохождения кейсов:  0.432s

Тест на 100 запросов к API 2Гис: 0.621s

Описание проваленных тестов:

- Карты не сортируются, когда категория указана не верно

- Удаление не верного id карты не выдает ошибки

- Обновление карты не проходит

- Добавляются карты с не корректной категорией
